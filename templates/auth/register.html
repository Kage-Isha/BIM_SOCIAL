{% extends 'base.html' %}

{% block title %}Register - BIM Social{% endblock %}

{% block anonymous_content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-cube text-white fs-3"></i>
                    </div>
                    <h2 class="mt-3 mb-2">Join BIM Social</h2>
                    <p class="text-muted">Connect with BIM professionals worldwide</p>
                </div>

                <form method="post" enctype="multipart/form-data" id="registerForm">
                    {% csrf_token %}
                    
                    <!-- Step 1: Basic Information -->
                    <div id="step1" class="step">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <div class="input-group">
                                <span class="input-group-text">@</span>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password1" class="form-label">Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password1" name="password1" required>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="password2" class="form-label">Confirm Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password2" name="password2" required>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword2">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary w-100" onclick="nextStep()">
                            Continue <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>

                    <!-- Step 2: Professional Information -->
                    <div id="step2" class="step d-none">
                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio (Optional)</label>
                            <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="location" name="location" placeholder="City, Country" required readonly>
                                    <button class="btn btn-outline-primary" type="button" id="getLocationBtn">
                                        <i class="fas fa-map-marker-alt me-1"></i>Get Location
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Click "Get Location" to verify your authentic location for security
                                </div>
                                <input type="hidden" id="latitude" name="latitude">
                                <input type="hidden" id="longitude" name="longitude">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="university" class="form-label">University (Optional)</label>
                                <input type="text" class="form-control" id="university" name="university" placeholder="Your university">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="specialization" class="form-label">Specialization</label>
                                <select class="form-select" id="specialization" name="specialization" required>
                                    <option value="">Select your specialization</option>
                                    <option value="architecture">Architecture</option>
                                    <option value="civil_engineering">Civil Engineering</option>
                                    <option value="mep">MEP Engineering</option>
                                    <option value="structural">Structural Engineering</option>
                                    <option value="project_management">Project Management</option>
                                    <option value="quantity_surveying">Quantity Surveying</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="experience_level" class="form-label">Experience Level</label>
                                <select class="form-select" id="experience_level" name="experience_level" required>
                                    <option value="">Select your level</option>
                                    <option value="student">Student</option>
                                    <option value="entry">Entry Level</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                    <option value="expert">Expert</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="profile_image" class="form-label">Profile Image (Optional)</label>
                            <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*">
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-fill" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i> Back
                            </button>
                            <button type="submit" class="btn btn-primary flex-fill" id="registerBtn">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="registerSpinner"></span>
                                Create Account
                            </button>
                        </div>
                    </div>
                </form>

                <hr class="my-4">

                <div class="text-center">
                    <p class="mb-0">Already have an account? 
                        <a href="{% url 'login' %}" class="text-decoration-none fw-medium">Sign in</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentStep = 1;

    function nextStep() {
        // Validate current step
        const step1Inputs = document.querySelectorAll('#step1 input[required], #step1 select[required]');
        let isValid = true;
        
        step1Inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        // Check password match
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;
        
        if (password1 !== password2) {
            document.getElementById('password2').classList.add('is-invalid');
            isValid = false;
        } else {
            document.getElementById('password2').classList.remove('is-invalid');
        }

        if (isValid) {
            document.getElementById('step1').classList.add('d-none');
            document.getElementById('step2').classList.remove('d-none');
            currentStep = 2;
        }
    }

    function validateStep2() {
        // Validate step 2 required fields
        const step2Inputs = document.querySelectorAll('#step2 input[required], #step2 select[required]');
        let isValid = true;
        
        step2Inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        // Validate location format (should contain city and country)
        const location = document.getElementById('location').value.trim();
        if (location && !location.includes(',')) {
            document.getElementById('location').classList.add('is-invalid');
            isValid = false;
            // Show error message
            let errorMsg = document.querySelector('#location + .invalid-feedback');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.className = 'invalid-feedback';
                document.getElementById('location').parentNode.appendChild(errorMsg);
            }
            errorMsg.textContent = 'Please provide location in format: City, Country';
        }

        return isValid;
    }

    function prevStep() {
        document.getElementById('step2').classList.add('d-none');
        document.getElementById('step1').classList.remove('d-none');
        currentStep = 1;
    }

    // Toggle password visibility
    document.getElementById('togglePassword1').addEventListener('click', function() {
        togglePasswordVisibility('password1', this);
    });

    document.getElementById('togglePassword2').addEventListener('click', function() {
        togglePasswordVisibility('password2', this);
    });

    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Handle form submission
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate step 2 before submission
        if (!validateStep2()) {
            return;
        }
        
        const btn = document.getElementById('registerBtn');
        const spinner = document.getElementById('registerSpinner');
        
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating Account...';
        
        // Submit the form
        this.submit();
    });

    // Real-time validation
    document.getElementById('username').addEventListener('blur', function() {
        const username = this.value;
        if (username.length >= 3) {
            // Check username availability (you can implement this with AJAX)
            // For now, just remove invalid class
            this.classList.remove('is-invalid');
        }
    });

    document.getElementById('password2').addEventListener('input', function() {
        const password1 = document.getElementById('password1').value;
        const password2 = this.value;
        
        if (password1 && password2) {
            if (password1 === password2) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        }
    });

    // Geolocation functionality
    document.getElementById('getLocationBtn').addEventListener('click', function() {
        const btn = this;
        const icon = btn.querySelector('i');
        const originalText = btn.innerHTML;
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Getting Location...';
        
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by this browser.');
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Store coordinates
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                
                // Reverse geocode to get address
                reverseGeocode(lat, lng).then(address => {
                    document.getElementById('location').value = address;
                    document.getElementById('location').classList.add('is-valid');
                    
                    // Success state
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>Location Verified';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                    successDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        Location verified successfully! Your authentic location helps us provide better security.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    btn.parentNode.parentNode.appendChild(successDiv);
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        if (successDiv.parentNode) {
                            successDiv.remove();
                        }
                    }, 5000);
                    
                }).catch(error => {
                    console.error('Reverse geocoding failed:', error);
                    // Fallback: use coordinates
                    document.getElementById('location').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    document.getElementById('location').classList.add('is-valid');
                    
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>Location Set';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                });
            },
            function(error) {
                let errorMessage = 'Unable to get your location. ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access and try again.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out.';
                        break;
                    default:
                        errorMessage += 'An unknown error occurred.';
                        break;
                }
                
                alert(errorMessage);
                btn.disabled = false;
                btn.innerHTML = originalText;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
            }
        );
    });

    // Reverse geocoding function using OpenStreetMap Nominatim API
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
            );
            const data = await response.json();
            
            if (data && data.address) {
                const city = data.address.city || data.address.town || data.address.village || data.address.municipality;
                const country = data.address.country;
                
                if (city && country) {
                    return `${city}, ${country}`;
                }
            }
            
            // Fallback to display_name
            if (data.display_name) {
                const parts = data.display_name.split(',');
                if (parts.length >= 2) {
                    return `${parts[0].trim()}, ${parts[parts.length - 1].trim()}`;
                }
            }
            
            throw new Error('Unable to determine location');
        } catch (error) {
            throw error;
        }
    }

    // Update validation to check if location is set via geolocation
    function validateStep2() {
        const step2Inputs = document.querySelectorAll('#step2 input[required], #step2 select[required]');
        let isValid = true;
        
        step2Inputs.forEach(input => {
            if (input.id === 'location') {
                // Check if location was set via geolocation
                const lat = document.getElementById('latitude').value;
                const lng = document.getElementById('longitude').value;
                
                if (!input.value.trim() || (!lat && !lng)) {
                    input.classList.add('is-invalid');
                    isValid = false;
                    
                    // Show specific error for location
                    let errorMsg = document.querySelector('#location + .invalid-feedback');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'invalid-feedback';
                        input.parentNode.parentNode.appendChild(errorMsg);
                    }
                    errorMsg.textContent = 'Please click "Get Location" to verify your authentic location.';
                } else {
                    input.classList.remove('is-invalid');
                }
            } else if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        return isValid;
    }
</script>
{% endblock %}
