{% extends 'base.html' %}

{% block title %}Feed - BIM Social{% endblock %}

{% block content %}
<!-- Create Post Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center">
            {% if user.profile.profile_image %}
                <img src="{{ user.profile.profile_image.url }}" alt="{{ user.username }}" class="avatar me-3">
            {% else %}
                <div class="avatar me-3 bg-primary d-flex align-items-center justify-content-center text-white">
                    {{ user.username|first|upper }}
                </div>
            {% endif %}
            <button class="btn btn-light flex-grow-1 text-start" data-bs-toggle="modal" data-bs-target="#createPostModal">
                What's on your mind, {{ user.first_name }}?
            </button>
        </div>
        <hr class="my-3">
        <div class="d-flex justify-content-around">
            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <i class="fas fa-image text-success me-2"></i>Photo/Video
            </button>
            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <i class="fas fa-smile text-warning me-2"></i>Feeling/Activity
            </button>
        </div>
    </div>
</div>

<!-- Posts Feed -->
<div id="posts-container">
    {% for post in posts %}
        {% include 'social/post_card.html' with post=post %}
    {% empty %}
        <div class="text-center py-5">
            <i class="fas fa-newspaper text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No posts yet</h4>
            <p class="text-muted">Follow some users or create your first post to get started!</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                Create Your First Post
            </button>
        </div>
    {% endfor %}
</div>

<!-- Load More Button -->
{% if posts.has_next %}
<div class="text-center mt-4">
    <button class="btn btn-outline-primary" id="loadMoreBtn" data-page="{{ posts.next_page_number }}">
        Load More Posts
    </button>
</div>
{% endif %}

<!-- Create Post Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createPostForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="d-flex align-items-start mb-3">
                        {% if user.profile.profile_image %}
                            <img src="{{ user.profile.profile_image.url }}" alt="{{ user.username }}" class="avatar me-3">
                        {% else %}
                            <div class="avatar me-3 bg-primary d-flex align-items-center justify-content-center text-white">
                                {{ user.username|first|upper }}
                            </div>
                        {% endif %}
                        <div>
                            <div class="fw-medium">{{ user.get_full_name|default:user.username }}</div>
                            <div class="text-muted small">{{ user.profile.specialization|default:"BIM Professional" }}</div>
                        </div>
                    </div>
                    
                    <textarea class="form-control border-0 fs-5" id="postCaption" name="caption" 
                              placeholder="What's on your mind?" rows="4" style="resize: none;"></textarea>
                    
                    <!-- Media Preview -->
                    <div id="mediaPreview" class="mt-3 d-none">
                        <div class="position-relative">
                            <img id="imagePreview" class="img-fluid rounded d-none" style="max-height: 400px;">
                            <video id="videoPreview" class="img-fluid rounded d-none" controls style="max-height: 400px;"></video>
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                    onclick="removeMedia()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Media Upload -->
                    <div class="border rounded p-3 mt-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">Add to your post</span>
                            <div>
                                <label for="mediaInput" class="btn btn-light btn-sm me-2">
                                    <i class="fas fa-image text-success"></i>
                                </label>
                                <input type="file" id="mediaInput" name="image" accept="image/*,video/*" class="d-none">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="postBtn">
                        <span class="spinner-border spinner-border-sm me-2 d-none" id="postSpinner"></span>
                        <span>Post</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle media upload preview
    document.getElementById('mediaInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const preview = document.getElementById('mediaPreview');
        const imagePreview = document.getElementById('imagePreview');
        const videoPreview = document.getElementById('videoPreview');
        
        // Reset previews
        imagePreview.classList.add('d-none');
        videoPreview.classList.add('d-none');
        
        if (file.type.startsWith('image/')) {
            imagePreview.src = URL.createObjectURL(file);
            imagePreview.classList.remove('d-none');
        } else if (file.type.startsWith('video/')) {
            videoPreview.src = URL.createObjectURL(file);
            videoPreview.classList.remove('d-none');
        }
        
        preview.classList.remove('d-none');
    });
    
    function removeMedia() {
        document.getElementById('mediaInput').value = '';
        document.getElementById('mediaPreview').classList.add('d-none');
    }
    
    // Handle post creation
    $('#createPostForm').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Form submitted');
        
        const formData = new FormData(this);
        const submitBtn = $('#postBtn');
        const spinner = $('#postSpinner');
        
        // Basic validation
        const caption = $('#postCaption').val().trim();
        const imageFile = $('#mediaInput')[0].files[0];
        
        console.log('Caption:', caption);
        console.log('Image file:', imageFile);
        
        if (!caption && !imageFile) {
            alert('Please add a caption, image, or video to your post.');
            return;
        }
        
        submitBtn.prop('disabled', true);
        spinner.removeClass('d-none');
        
        // Debug FormData contents
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
        
        // AJAX removed - using Django form submission
        document.getElementById('createPostForm').submit();
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
            },
            success: function(response) {
                if (response.success) {
                    $('#createPostModal').modal('hide');
                    $('#createPostForm')[0].reset();
                    $('#mediaPreview').addClass('d-none');
                    $('#imagePreview, #videoPreview').addClass('d-none');
                    
                    // Show success message
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>Post created successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    $('.container-fluid').prepend(alertHtml);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                        $('.alert-success').fadeOut();
                    }, 3000);
                    
                    location.reload(); // Reload to show new post
                } else {
                    alert('Error: ' + (response.error || 'Unknown error occurred'));
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = 'An error occurred while creating the post.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert('Error: ' + errorMessage);
            },
            complete: function() {
                submitBtn.prop('disabled', false);
                spinner.addClass('d-none');
            }
        });
    });
    
    // Like button now uses Django forms - no AJAX needed
    
    // Save button now uses Django forms - no AJAX needed
    
    
    // Load more posts now uses page navigation - no AJAX needed
    document.getElementById('loadMoreBtn')?.addEventListener('click', function() {
        const page = this.dataset.page;
        window.location.href = `/feed/?page=${page}`;
    });
</script>
{% endblock %}
